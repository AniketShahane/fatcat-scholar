
{% macro tag_label(tag) -%}
  {% if tag == "oa" %}
    <span class="ui label basic orange small" title="Open Access"><i class="ui icon unlock"></i>OA</span>
  {% elif tag == "scielo" %}
    <span class="ui label basic purple small" title="Hosted on SciELO platform">SciELO</span>
  {% elif tag == "ojs" %}
    <span class="ui label basic purple small" title="Hosted with Open Journal Systems">OJS</span>
  {% elif tag == "wordpress" %}
    <span class="ui label basic purple small" title="Hosted with Wordpress">Wordpress</span>
  {% elif tag == "road" %}
    {# skip for now; no curration? #}
    {# <span class="ui label basic orange small" title="ISSN Registry of Open Access Journals">ROAD</span> #}
  {% elif tag == "szczepanski" %}
    {# pass #}
  {% elif tag == "doaj" %}
    <span class="ui label basic orange small" title="Directory of Open Access Journals">DOAJ</span>
  {% else %}
    <span class="ui label small">{{ _(tag) }}</span>
  {% endif %}
{% endmacro %}

{% macro fulltext_search_result_row(paper) -%}
<div class="ui grid">
<div class="thirteen wide column">
  {# ### TITLE ROW #}
  <div style="margin-bottom: 0.1em; font-size: 1.2em; font-weight: bold;">

    {% if paper.doc_type == "work" %}
      {# "best URL" calculation #}
      {% if paper.biblio.pmcid %}
      <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/{{ paper.biblio.pmcid }}/"
      {% elif paper.biblio.pmid %}
      <a href="https://pubmed.ncbi.nlm.nih.gov/{{ paper.biblio.pmid }}/"
      {% elif paper.biblio.arxiv_id %}
      <a href="https://arxiv.org/abs/{{ paper.biblio.arxiv_id }}/"
      {% elif paper.biblio.doi %}
      <a href="https://doi.org/{{ paper.biblio.doi }}"
      {% else %}
      <a href="https://fatcat.wiki/release/{{ paper.biblio.release_ident }}"
      {% endif %}
      style="color: #2224c7;" target="_blank">
        {% if paper.biblio.title %}
          {{ paper.biblio.title[:512] }}
          {% if paper.biblio.title|length > 512 %}...{% endif %}
        {% else %}
          [blank]
        {% endif %}
      </a>
      {# release type suffix #}
      <span style="font-weight: normal; text-transform: uppercase; font-weight: bold;">
      {% if paper.biblio.release_type in ("article-journal", "paper-conference") or paper.doc_type == "sim_page" %}
        {# pass #}
      {% elif paper.biblio.release_type in ("book", "chapter", "dataset") %}
        [{{ _(paper.biblio.release_type) }}]
      {% elif not paper.biblio.release_type %}
        [{{ _("unknown") }}]
      {% else %}
        [{{ _(paper.biblio.release_type) }}]
      {% endif %}
      </span>

      {# show inverse of title/original_title above #}
      {% if paper.biblio.original_title and paper.biblio.title != paper.biblio.original_title %}
        <br>
        <i style="font-weight: bold;">
          {{ paper.biblio.original_title[:512] }} {% if paper.biblio.original_title|length > 512 %}...{% endif %}
        </i>
      {% endif %}

    {% elif paper.doc_type == "sim_page" %}
      <a target="_blank" href="https://archive.org/details/{{ paper.ia_sim.issue_item }}/page/{{ paper.ia_sim.first_page }}" style="color: #2224c7;">Page {{ paper.ia_sim.first_page }}</a> of <a target="_blank" href="https://archive.org/details/{{ paper.ia_sim.issue_item }}" style="color: #2224c7;">{{ paper.biblio.container_name }}</a> (<a target="_blank" href="https://archive.org/details/{{ paper.ia_sim.issue_item }}" style="color: #2224c7;">Vol. {{ paper.biblio.volume }}, Issue {{ paper.biblio.issue }}</a>)
    {% endif %}

  </div>

  {# ### AUTHOR ROW #}
  {% if paper.biblio.contrib_names %}
    <div style="margin-top: 0.1em; margin-bottom: 0.2em; font-size: 1.1em;">
    {{ ", ".join(paper.biblio.contrib_names[:12]) }}
    {% if paper.biblio.contrib_names|length > 12 %}<i>(+{{ paper.biblio.contrib_names|length - 12 }} others)</i>{% endif %}
    </div>
  {% endif %}


  {# ### JOURNAL ROW #}
  {% if paper.biblio.release_year %}
    {{ paper.biblio.release_year }}
  {% endif %}
  {% if paper.biblio.container_name %}
    <i>
    {% if paper.biblio.container_ident %}
      <a target="_blank" href="https://fatcat.wiki/container/{{ paper.biblio.container_ident }}" style="color: black;">{{ paper.biblio.container_name }}</a>
    {% elif paper.doc_type == "sim_page" %}
      <a target="_blank" href="https://archive.org/details/{{ paper.ia_sim.pub_collection }}" style="color: black;">{{ paper.biblio.container_name }}</a>
    {% else %}
      {{ paper.biblio.container_name }}
    {% endif %}
    </i>
    {% if paper.container_is_oa %}<i class="icon unlock orange small"></i>{% endif %}
  {% endif %}
  {% if paper.biblio.withdrawn_status %}
    <b style="color: red;"><code>[{{ paper.biblio.withdrawn_status }}]</code></b>
  {% endif %}
  {% if paper.biblio.release_stage == "accepted" %}
    <b style="color: brown;"><code>[{{ paper.biblio.release_stage }}]</code></b>
  {% elif paper.biblio.release_stage and paper.biblio.release_stage != "published" %}
    <b style="color: red;"><code>[{{ paper.biblio.release_stage }}]</code></b>
  {% elif not paper.biblio.release_stage %}
    <b style="color: red;"><code>[{{ _("unpublished?") }}]</code></b>
  {% endif %}

  {# ### ABSTRACT / QUERY HIGHLIGHT #}
  {% if paper._highlights %}
    <div style="padding-top: 1em; padding-bottom: 0.5em;" class="search_highlights">
    {% for highlight in paper._highlights %}
      {{ highlight|safe }} &nbsp;...&nbsp;
    {% endfor %}
    </div>
  {% elif paper.abstracts %}
    <div style="padding-top: 1em; padding-bottom: 0.5em;">
      {% if paper.abstracts[0].body|length > 500 %}
        {{ paper.abstracts[0].body[:500] }}...
      {% else %}
        {{ paper.abstracts[0].body }}
      {% endif %}
    </div>
  {% else %}
    <br>
  {% endif %}

  {# ### IDENTIFIERS #}
  {% if paper.biblio.doi %}
    <a target="_blank" href="https://doi.org/{{paper.biblio.doi }}" style="color: green;">doi:{{ paper.biblio.doi }}</a> &nbsp;
  {% endif %}
  {% if paper.biblio.pmid %}
    <a target="_blank" href="https://www.ncbi.nlm.nih.gov/pubmed/{{paper.biblio.pmid }}" style="color: green;">pmid:{{ paper.biblio.pmid }}</a> &nbsp;
  {% endif %}
  {% if paper.biblio.pmcid %}
    <a target="_blank" href="https://pubmed.ncbi.nlm.nih.gov/{{paper.biblio.pmcid }}/" style="color: green;">pmcid:{{ paper.biblio.pmcid }}</a> &nbsp;
  {% endif %}
  {% if paper.biblio.arxiv_id %}
    <a target="_blank" href="https://arxiv.org/abs/{{paper.biblio.arxiv_id }}" style="color: green;">arXiv:{{ paper.biblio.arxiv_id }}</a> &nbsp;
  {% endif %}
  {% if paper.biblio.release_ident %}
    <a target="_blank" href="https://fatcat.wiki/release/{{paper.biblio.release_ident}}" style="color: green;">fatcat:{{ paper.biblio.release_ident}}</a> &nbsp;
  {% endif %}

  {# ### TAGS #}
  <div style="margin-top: 0.2em;">
    {# colors to use: olive, brown, grey, pink, red, etc #}
    {# TODO: remove doc for ES 7.x-style lack of type #}
    {# TODO: only show 'json' link if from cluster? #}
    <a target="_blank" href="{{ settings.ELASTICSEARCH_BACKEND }}/{{ settings.ELASTICSEARCH_FULLTEXT_INDEX }}/_doc/{{ paper.key }}">
      <span class="ui label small">json</span>
    </a>
    {% if paper.biblio.release_ident %}
      <a target="_blank" href="https://fatcat.wiki/release/{{ paper.biblio.release_ident }}">
        <span class="ui label small">metadata</span>
      </a>
    {% endif %}

    {% for tag in paper.tags %}
      {{ tag_label(tag) }}
    {% endfor %}
  </div>

  {# ### COLLAPSED HITS  #}
  {% if paper._collapsed_count > 0 %}
    <div style="padding-top: 0.5em;">
      <button class="ui compact basic blue button" form="search_form" type="submit" name="collapse_pages" value="false">
          <i class="ui icon zoom-in"></i>
          Show {{ paper._collapsed_count }} additional hits from this issue
      </button>
    </div>
  {% endif %}

</div>
<div class="three wide left aligned column" style="padding-top: 0.5em; padding-right: 0.5em;">
  {% if paper.fulltext.access_url %}
      {# <img src="{{ settings.COVID19_FULLTEXT_HOST }}{{ paper.fulltext.thumbnail_url }}" style="border: 1px solid grey; max-height: 12em; max-width: 100%;"> #}
    {% if paper.fulltext.thumbnail_url %}
      <div class="ui card" style="margin-bottom: 0.2em;">
        <a class="image" target="_blank" href="{{ paper.fulltext.access_url}}">
          <img src="{{ paper.fulltext.thumbnail_url }}">
        </a>
      </div>
    {% endif %}
    <a target="_blank" href="{{ paper.fulltext.access_url}}">
      <div style="width: 100%; opacity: 0.65; text-align: center;">
        {# TODO: could have other hover info, like mimetype icon and file size? #}
        <span>
        {% if paper.fulltext.access_type == "wayback" %}
          web.archive.org
        {% elif paper.fulltext.access_type in ["ia_sim", "ia_file"] %}
          archive.org
        {% endif %}
        {% if paper.fulltext.file_mimetype == "application/pdf" %}
          <i class="file pdf outline icon"></i>
        {% elif paper.fulltext.access_type == "ia_sim" %}
          <i class="film icon"></i>
        {% endif %}
        </span>
      </div>
    </a>
  {% else %}
    {# No Fulltext #}
  {% endif %}
</div>
</div>
{% endmacro %}

{% macro search_pagination(hits, top) %}
{% if hits.offset > 0 %}
  <button class="text-button" form="search_form" type="submit" name="offset" value="{{ hits.offset - hits.limit }}" style="margin-right: 2em;">
    <a>&#xab; Previous</a>
  </button>
{% else %}
  <span style="color:gray">&#xab; Previous</span>
{% endif %}
<i>Showing results {{ hits.offset }} &mdash; {{ hits.offset + hits.limit }} out of {{ "{:,}".format(hits.count_found) }} results</i>
<button class="text-button" form="search_form" type="submit" name="offset" value="{{ hits.offset + hits.limit }}" style="margin-left: 2em;">
  <a>Next &#xbb;</a>
</button>
{% endmacro %}

{% macro query_option(options, selected) -%}
<span style="color: rgba(0,0,0,0.4);">{{ _(options.label) }}</span>
<div class="ui link list" style="margin-top: 0.3em;">
  {% for opt in options.list %}
    <button class="text-button" form="search_form" type="submit" name="{{ options.slug }}" value="{{ opt.slug }}">
      {% if selected == opt.slug or (not selected and opt.slug == options.default) %}
        <span style="font-weight: bold;">
      {% else %}
        <span>
      {% endif %}
      {{ _(opt.label) }}
      </span>
    </button>
    <br>
    </span>
  {% endfor %}
</div>
<br>
{% endmacro %}

{% macro query_hidden(options, selected) -%}
{% if selected %}
  <input form="search_form" type="hidden" name="{{ options.slug }}" value="{{ selected }}">
{% endif %}
{% endmacro %}
