
{% macro tag_label(tag) -%}
  {% if tag == "oa" %}
    <span class="ui label basic orange small" title="Open Access">OA</span>
  {% elif tag == "jstor" %}
    <span class="ui label basic purple small" title="Preserved in JSTOR">JSTOR</span>
  {% elif tag == "scielo" %}
    <span class="ui label basic purple small" title="Hosted on SciELO platform">SciELO</span>
  {% elif tag == "ojs" %}
    <span class="ui label basic purple small" title="Hosted with Open Journal Systems">OJS</span>
  {% elif tag == "wordpress" %}
    <span class="ui label basic purple small" title="Hosted with Wordpress">Wordpress</span>
  {% elif tag == "road" %}
    {# skip for now; no curration? #}
    {# <span class="ui label basic orange small" title="ISSN Registry of Open Access Journals">ROAD</span> #}
  {% elif tag == "szczepanski" %}
    <span class="ui label basic orange small" title="Szcezepanski OA Journal List">Szczepanski</span>
  {% elif tag == "doaj" %}
    <span class="ui label basic orange small" title="Directory of Open Access Journals">DOAJ</span>
  {% elif tag.startswith("lang:") %}
    <span class="ui label basic black small" title="ISO Language Code">{{ tag }}</span>
  {% else %}
    {# disabling "other" tags for now #}
    {# <span class="ui label basic grey small">{{ _(tag) }}</span> #}
  {% endif %}
{% endmacro %}

{% macro external_identifiers(biblio) -%}
  {# NOTE: should be able to call with paper.biblio or any paper.release[] #}
  {% if biblio.doi %}
    <a target="_blank" rel="external noopener noreferrer" href="https://doi.org/{{ biblio.doi }}" style="color: green;">doi:{{ biblio.doi }}</a> &nbsp;
  {% endif %}
  {% if biblio.pmid %}
    <a target="_blank" rel="external noopener" href="https://www.ncbi.nlm.nih.gov/pubmed/{{ biblio.pmid }}" style="color: green;">pmid:{{ biblio.pmid }}</a> &nbsp;
  {% endif %}
  {% if biblio.pmcid %}
    <a target="_blank" rel="external noopener" href="https://pubmed.ncbi.nlm.nih.gov/{{ biblio.pmcid }}/" style="color: green;">pmcid:{{ biblio.pmcid }}</a> &nbsp;
  {% endif %}
  {% if biblio.arxiv_id %}
    <a target="_blank" rel="external noopener" href="https://arxiv.org/abs/{{ biblio.arxiv_id }}" style="color: green;">arXiv:{{ biblio.arxiv_id }}</a> &nbsp;
  {% endif %}
  {% if biblio.dblp_id %}
    <a target="_blank" rel="external noopener" href="https://dblp.org/rec/{{ biblio.dblp_id }}.html" style="color: green;">dblp:{{ biblio.dblp_id }}</a> &nbsp;
  {% endif %}
  {% if biblio.doaj_id %}
    <a target="_blank" rel="external noopener" href="https://doaj.org/article/{{ biblio.doaj_id }}" style="color: green;">doaj:{{ biblio.doaj_id }}</a> &nbsp;
  {% endif %}
  {% if biblio.release_ident or biblio.ident %}
    <a target="_blank" rel="external noopener" href="https://fatcat.wiki/release/{{ biblio.release_ident or biblio.ident }}" style="color: green;">fatcat:{{ biblio.release_ident or biblio.ident }}</a> &nbsp;
  {% endif %}
{% endmacro %}

{% macro journal_row(biblio, paper) -%}
  {# NOTE: should be able to call with paper.biblio or any paper.release[] #}
  {% if biblio.release_year %}
    <span title="{{ biblio.release_date or '' }}">{{ biblio.release_year }}</span>
  {% endif %}
  {% if biblio.container_name %}
    <i {% if biblio.publisher %}title="{{ biblio.publisher }}"{% endif %}>
    {% if biblio.container_ident %}
      <a target="_blank" rel="noopener" href="https://fatcat.wiki/container/{{ biblio.container_ident }}" style="color: black;">{{ biblio.container_name }}</a>
    {% elif paper.doc_type == "sim_page" %}
      <a target="_blank" rel="noopener" href="https://archive.org/details/{{ paper.ia_sim.pub_collection }}" style="color: black;">{{ biblio.container_name }}</a>
    {% else %}
      {{ biblio.container_name }}
    {% endif %}
    </i>
    &nbsp;
  {% endif %}

  {% if biblio.release_stage == "submitted" %}
    <span class="release-stage" >pre-print</span>
  {% elif biblio.release_stage and biblio.release_stage != "published" %}
    <span class="release-stage">{{ biblio.release_stage }}</span>
  {% elif not biblio.release_stage %}
    <span class="release-stage">unpublished</span>
  {% endif %}

  {% if biblio.withdrawn_status %}
    <span class="release-stage" style="color: red;">{{ biblio.withdrawn_status }}</span>
  {% endif %}
{% endmacro %}

{% macro fulltext_search_result_row(paper, locale=None, debug_mode=False) -%}
<div class="ui stackable doubling grid">
<div class="thirteen wide column biblio-record">
  {# ### TITLE ROW #}
  <h3 class="biblio-title">

    {% if paper.doc_type == "work" %}
      <a style="color: #2224c7; cursor: pointer;" onclick="document.getElementById('access-modal-{{ paper.key }}').showModal()">
        {% if paper.biblio.title %}
          {{ paper.biblio.title[:512] }}
          {% if paper.biblio.title|length > 512 %}...{% endif %}
        {% else %}
          [blank]
        {% endif %}
      </a>
      {# release type suffix #}
      <span class="release-type" >
      {% if paper.biblio.release_type in ("article-journal", "paper-conference") or paper.doc_type == "sim_page" %}
        {# pass #}
      {% elif paper.biblio.release_type in ("book", "chapter", "dataset") %}
        [{{ _(paper.biblio.release_type) }}]
      {% elif not paper.biblio.release_type %}
        [{{ _("unknown") }}]
      {% else %}
        [{{ _(paper.biblio.release_type) }}]
      {% endif %}
      </span>

      {# show inverse of title/original_title above #}
      {% if paper.biblio.original_title and paper.biblio.title != paper.biblio.original_title %}
        <br>
        <span class="original-title">
          {{ paper.biblio.original_title[:512] }} {% if paper.biblio.original_title|length > 512 %}...{% endif %}
        </span>
      {% endif %}

    {% elif paper.doc_type == "sim_page" %}
      <a target="_blank" rel="noopener" href="https://archive.org/details/{{ paper.ia_sim.issue_item }}/page/{{ paper.ia_sim.first_page }}" title="{{ _('access microfilm on archive.org') }}" {% if settings.ENABLE_GOATCOUNTER %}data-goatcounter-click="serp-title-sim-page"{% endif %}>
        {% trans page_num = paper.ia_sim.first_page, journal_name = paper.biblio.container_name, volume = paper.biblio.volume, issue = paper.biblio.issue %}Page {{ page_num }} of {{ journal_name }} Vol. {{ volume }}, Issue {{ issue }}{% endtrans %}
      </a>
      <span class="release-type">[{{ _("page") }}]</span>
    {% endif %}

  </h3>

  {# ### AUTHOR ROW #}
  {% if paper.biblio.contrib_names %}
    <div class="author-row">
    {{ ", ".join(paper.biblio.contrib_names[:12]) }}
    {% if paper.biblio.contrib_names|length > 12 %}<i>(+{{ paper.biblio.contrib_names|length - 12 }} others)</i>{% endif %}
    </div>
  {% endif %}


  {# ### JOURNAL ROW #}
  {{ journal_row(paper.biblio, paper) }}

  {# ### ABSTRACT / QUERY HIGHLIGHT #}
  {% if paper._highlights %}
    <div style="padding-top: 0.5em; padding-bottom: 0.5em;" class="search_highlights">
    {# this highlight HTML escape hacking should not be necessary in ES 7.x with highlight escaping #}
    {# but for now we manually escape, then de-escape the 'em' highlight tags #}
    {% autoescape false %}
      {% for highlight in paper._highlights[:3] %}
        {{ highlight|e|replace("&lt;em&gt;", "<em>")|replace("&lt;/em&gt;", "</em>") }} &nbsp;...&nbsp;
      {% endfor %}
    {% endautoescape %}
    </div>
  {% elif paper.abstracts %}
    <div style="padding-top: 0.5em; padding-bottom: 0.5em;">
      {% if paper.abstracts[0].body|length > 500 %}
        {{ paper.abstracts[0].body | truncate(500, False, '') }}
        <details style="display:inline;">
          <summary>{% trans %}more &raquo;{% endtrans %}</summary>
          ... {{ paper.abstracts[0].body[480:] }}
        </details>
      {% else %}
        {{ paper.abstracts[0].body }}
      {% endif %}
    </div>
  {% else %}
    <br>
  {% endif %}

  {# ### IDENTIFIERS #}
  {{ external_identifiers(paper.biblio) }}

  <div style="margin-top: 0.2em;">
  {# ### TAGS #}
    {# colors to use: olive, brown, grey, pink, red, etc #}
    {# TODO: remove doc for ES 7.x-style lack of type #}
    {# TODO: only show 'json' link if from cluster? #}
    {% if debug_mode %}
      <a target="_blank" rel="noopener" href="{{ settings.ELASTICSEARCH_FRONTEND }}/{{ settings.ELASTICSEARCH_FULLTEXT_INDEX }}/_doc/{{ paper.key }}">
        <span class="ui label small" title="search document JSON debug link">json</span>
      </a>
    {% endif %}

    {% for tag in paper.tags|sort %}
      {# HACK: don't show "oa" tag if already obvious #}
      {% if tag != "oa" or ("doaj" not in paper.tags and "szczepanski" not in paper.tags) %}
        {{ tag_label(tag) }}
      {% endif %}
    {% endfor %}
    {% if paper.biblio.lang_code and paper.biblio.lang_code != (locale or 'en') %}
      {{ tag_label("lang:" + paper.biblio.lang_code) }}
    {% endif %}

  </div>

</div>

<div class="three wide left aligned column" style="padding-top: 0.5em; padding-right: 0.5em; min-width: 10em;">
  {# ### ACCESS LINKS #}

  {# archive links (if available) #}
  {% if paper.fulltext and paper.fulltext.access_url %}
    {% if paper.fulltext.file_mimetype == "application/pdf" %}
      {% set access_alt = _('fulltext PDF download') %}
    {% elif paper.fulltext.access_type == "ia_sim" %}
      {% set access_alt = _('read fulltext microfilm') %}
    {% else %}
      {% set access_alt = _('fulltext access') %}
    {% endif %}
    <a target="_blank" rel="noopener" href="{{ paper.fulltext.access_url}}" title="{{ access_alt }}" {% if settings.ENABLE_GOATCOUNTER %}data-goatcounter-click="serp-fulltext-button"{% endif %}>
      <button class="ui simple dropdown fluid compact black labeled icon button serp-button">
        <i class="icon" style="background: no-repeat center / 50% url('/static/ia-favicon.ico');"></i>
        {% if paper.fulltext.access_type in ["wayback", "ia_file"] %}
          {% if paper.fulltext.file_mimetype == "application/pdf" or not paper.fulltext.file_mimetype %}
            PDF
          {% elif paper.fulltext.file_mimetype == "text/html" %}
            HTML
          {% elif paper.fulltext.file_mimetype == "text/xml" %}
            XML
          {% else %}
            File |{{ paper.fulltext.file_mimetype }}|
          {% endif %}
          {% if paper.fulltext.size_bytes %}
            ({{ paper.fulltext.size_bytes }})
          {% endif %}
        {% elif paper.fulltext.access_type == "ia_sim" %}
          Microfilm
        {% else %}
          Other
        {% endif %}
      {% if paper.fulltext and paper.fulltext.thumbnail_url %}
        <div class="menu" style="left: -110%; margin-top: -2.5em;">
          <img src="{{ paper.fulltext.thumbnail_url }}" alt="fulltext thumbnail" loading="lazy">
        </div>
      {% endif %}
      </button>
    </a>
  {% endif %}

  {# publisher #}
  {% if paper.biblio.doi %}
    <a target="_blank" rel="external noopener noreferrer" href="https://doi.org/{{paper.biblio.doi }}" style="color: green;">
      <button class="ui fluid left aligned compact blue labeled icon button serp-button">
        {% if "oa" in paper.tags %}
          <i class="unlock alternate icon" style="background-color: #fb971f;"></i>
        {% else %}
          <i class="linkify icon"></i>
        {% endif %}
        {# TODO: detect prefix? JSTOR, biorxiv, medrxiv, zenodo, figshare, dryad, etc #}
        {# helpful: https://gist.github.com/TomDemeranville/8699224 #}
        {% if paper.biblio.doi_prefix == "10.6084" %}
          figshare.com
        {% elif paper.biblio.doi_prefix == "10.5281" %}
          zenodo.org
        {% elif paper.biblio.doi_prefix == "10.1371" %}
          plos.org
        {% elif paper.biblio.doi_prefix == "10.1016" %}
          elsevier.com
        {% elif paper.biblio.doi_prefix in ["10.1186", "10.1007"] %}
          springer.com
        {% elif paper.biblio.doi_prefix in ["10.1042", "10.1111", "10.1177"] %}
          sagepub.com
        {% elif paper.biblio.doi_prefix in ["10.1080"] %}
          tandfonline.com
        {% else %}
          Publisher DOI
        {% endif %}
      </button>
    </a>
  {% endif %}

  {# trusted platform fulltext links #}
  {# TODO: DOAJ, dblp #}
  {% if paper.biblio.arxiv_id %}
    <a target="_blank" rel="noopener" href="https://arxiv.org/abs/{{ paper.biblio.arxiv_id }}" title="arxiv.org access">
      <button class="ui fluid compact blue labeled icon button serp-button">
        <i class="file alternate outline icon"></i>
        arxiv.org
      </button>
    </a>
  {% elif paper.biblio.pmcid %}
    <a target="_blank" rel="noopener" href="https://www.ncbi.nlm.nih.gov/pmc/articles/{{paper.biblio.pmcid }}" title="pubmed link">
      <button class="ui fluid compact blue labeled icon button serp-button">
        <i class="file alternate outline icon"></i>
        Pubmed Central
      </button>
    </a>
  {% endif %}

  {# ### VERSIONS #}
  {% if (paper.access and paper.access|length > 1) or (paper.releases and paper.releases|length > 1) %}
    <a style="color: #2224c7; cursor: pointer;" onclick="document.getElementById('access-modal-{{ paper.key }}').showModal()">
      <div class="ui fluid compact basic blue labeled icon button serp-button">
        <i class="ui icon add"></i>
        {% trans %}Other Versions{% endtrans %}
      </div>
    </a>
  {% endif %}

  {# ### COLLAPSED HITS  #}
  {% if paper._collapsed_count > 0 %}
    <button class="ui fluid left aligned basic blue compact button serp-button" form="search_form" type="submit" name="collapse_key" value="{{ paper.collapse_key }}">
      <i class="ui icon zoom-in"></i>
      {% trans trimmed count=paper._collapsed_count %}
        Same Issue ({{ count }})
      {% endtrans %}
    </button>
  {% endif %}

  {# ### OTHER ACTIONS #}
  <div class="action-bar">
    <a onclick="document.getElementById('cite-modal-{{ paper.key }}').showModal()">
      <button class="circular ui icon compact basic button">
        <i class="quote left icon"></i>
      </button>
    </a>
    <a href="https://fatcat.wiki/release/{{ paper.biblio.release_ident }}" target="_blank" rel="noopener" title="{{ _('access fatcat landing page') }}">
      <button class="circular ui icon compact basic button">
        <i class="edit icon"></i>
      </button>
    </a>
  </div>

  {# ### CITATION MODAL #}
  {% if paper.doc_type == "work" %}
  <dialog id="cite-modal-{{ paper.key }}">
    <button class="circular ui right floated compact basic icon button" onclick="this.parentElement.close()">
      <i class="close icon"></i>
    </button>
    <h2>{% trans %}Cite Work{% endtrans %}</h2>
    <table class="ui very basic table">
      <tbody>
        <tr>
          <td>Generic</td>
          <td>{{ paper._obj.biblio.citation_str("default") }}</td>
        </tr>
        <tr>
          <td>BibTeX</td>
          <td><pre>{{ paper._obj.biblio.citation_str("bibtex") }}</pre></td>
        </tr>
      </tbody>
    </table>
  </dialog>
  {% endif %}

  {# ### VERSIONS MODAL #}
  <dialog id="access-modal-{{ paper.key }}">
    <button class="circular ui right floated compact basic icon button" onclick="this.parentElement.close()">
      <i class="close icon"></i>
    </button>

    <h2>{% trans %}Access Options{% endtrans %}</h2>
    {% if paper.fulltext and paper.fulltext.thumbnail_url %}
      <a href="{{ paper.fulltext.access_url }}">
        <img src="{{ paper.fulltext.thumbnail_url }}" alt="fulltext thumbnail" loading="lazy">
      </a>
    {% endif %}

    {% for access in paper.access %}
      {% if access.access_type == "ia_sim" %}
        <p>There is a digitized microfilm copy <a href="{{ access.access_url }}">at archive.org</a>.
      {% elif access.access_type == "ia_file" %}
        <p>There is a <code>{{ access.mimetype }}</code> file <a href="{{ access.access_url }}">at archive.org</a>.
      {% elif access.access_type == "wayback" %}
        <p>There is a <code>{{ access.mimetype }}</code> file <a href="{{ access.access_url }}">in The Wayback Machine</a>.
      {% else %}
        <p>Some other <a href="{{ access.access_url }}">access here</a>.
      {% endif %}
    {% endfor %}
    {% if paper.biblio.doi %}
      <p>You can visit the publisher <a href="{{ paper.biblio.doi }}">landing page</a>.
    {% endif %}

    {% if paper.releases|length > 1 %}
      <h2>All Versions</h2>
      {% for release in paper.releases %}
        <div class="biblio-record">
          {{ journal_row(release, paper) }}
          <br>
          {{ external_identifiers(release) }}
        </div>
        <br>
      {% endfor %}
    {% endif %}
  </dialog>

</div>
</div>
{% endmacro %}

{% macro search_pagination(hits, top) %}
{% if hits.offset > 0 %}
  <button class="text-button" form="search_form" type="submit" name="offset" value="{{ hits.offset - hits.limit }}" style="margin-right: 2em;" rel="prev">
    <a>&#xab; {% trans %}Previous{% endtrans %}</a>
  </button>
{% else %}
  <span style="color:rgba(0,0,0,0.55); margin-right: 2em;">&#xab; {% trans %}Previous{% endtrans %}</span>
{% endif %}
<i>
  {% trans trimmed start=(hits.offset + 1), end=(hits.offset + hits.limit), total="{:,}".format(hits.count_found) %}
    Showing results {{ start }} &mdash; {{ end }} out of {{ total }} results
  {% endtrans %}
</i>
{% if hits.offset + hits.limit < hits.count_found %}
<button class="text-button" form="search_form" type="submit" name="offset" value="{{ hits.offset + hits.limit }}" style="margin-left: 2em;" rel="next">
  <a>{% trans %}Next{% endtrans %} &#xbb;</a>
{% else %}
  <span style="color:rgba(0,0,0,0.55); margin-left: 2em;">{% trans %}Next{% endtrans %} &#xbb;</span>
{% endif %}
</button>
{% endmacro %}

{% macro query_option(options, selected) -%}
<div>
  <label for="{{ options.slug }}" style="color: rgba(0,0,0,0.55);">{{ _(options.label) }}</label>
  <div class="ui link list" style="margin-top: 0.3em;">
    {% for opt in options.list %}
      <button class="text-button" form="search_form" type="submit" name="{{ options.slug }}" value="{{ opt.slug }}">
        {% if selected == opt.slug or (not selected and opt.slug == options.default) %}
          <span style="font-weight: bold;">
        {% else %}
          <span>
        {% endif %}
        {{ _(opt.label) }}
        </span>
      </button>
      <br>
    {% endfor %}
  </div>
</div>
<br>
{% endmacro %}

{% macro query_hidden(options, selected) -%}
{% if selected %}
  <input form="search_form" type="hidden" name="{{ options.slug }}" value="{{ selected }}">
{% endif %}
{% endmacro %}
